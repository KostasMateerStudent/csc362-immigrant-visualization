<!-- Credits for starter code: https://gist.github.com/wboykinm/dbbe50d1023f90d4e241712395c27fb3  -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../style.css" />
    <style type="text/css">
      /* Legend Font Style */

      /* Legend Position Style */
      .legend {
        position: relative;
        justify-content: left;
        top: -525px;
        left: 120px;
      }

      .axis text {
        font: 10px sans-serif;
      }

      .axis line,
      .axis path {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      #chart {
        display: flex;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div class="jumbotron text-center">
      <h1>Visualizing Foreign Immigrant Admissions</h1>
      <p style="text-align: center">Kostas Mateer and Sathish Karthikeyan</p>
      <a href="../index.html" class="btn btn-default" role="button"
        >Go back to Main Page</a
      >
    </div>
    <div class="container">
      <div class="row" id="container-chart">
        <div id="chart"></div>
      </div>
      <div class="row">
        <a href="../index.html" class="btn btn-default btn-sm" role="button">Go back to Main Page</a>
      </div>
    </div>
    <script type="text/javascript">
      //Width and height of map

      var margin = { top: 40, right: 20, bottom: 60, left: 80 };
      (width = 1000 - margin.left - margin.right),
        (height = 500 - margin.top - margin.bottom);

      var lowColor = "#ffffb2";
      var highColor = "#b10026";

      // D3 Projection
      var projection = d3
        .geoAlbersUsa()
        .translate([width / 2, height / 2]) // translate to center of screen
        .scale([1000]); // scale things down so see entire US

      // Define path generator
      var path = d3
        .geoPath() // path generator that will convert GeoJSON to SVG paths
        .projection(projection); // tell path generator to use albersUsa projection

      var margin = { top: 100, right: 50, bottom: 60, left: 80 },
        width = 1000 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;

      const tooltip = d3
        .select("body")
        .append("div")
        .attr("class", "d3-tooltip")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden")
        .style("padding", "15px")
        .style("background", "rgba(0,0,0,0.6)")
        .style("border-radius", "5px")
        .style("color", "#fff")
        .text("a simple tooltip");
      //Create SVG element and append map to the SVG
      var svg = d3
        .select("#chart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // Load in my states data!
      d3.csv("../data/statesdata.csv", function (data) {
        var dataArray = [];
        for (var d = 0; d < data.length; d++) {
          dataArray.push(parseFloat(data[d].value));
        }
        var minVal = d3.min(dataArray);
        var maxVal = d3.max(dataArray);
        var ramp = d3
          .scaleLinear()
          .domain([minVal, maxVal])
          .range([lowColor, highColor]);

        // Load GeoJSON data and merge with states data
        d3.json("../json/us-states.json", function (json) {
          // Loop through each state data value in the .csv file
          for (var i = 0; i < data.length; i++) {
            // Grab State Name
            var dataState = data[i].state;

            // Grab data value
            var dataValue = data[i].value;

            // Find the corresponding state inside the GeoJSON
            for (var j = 0; j < json.features.length; j++) {
              var jsonState = json.features[j].properties.name;

              if (dataState == jsonState) {
                // Copy the data value into the JSON
                json.features[j].properties.value = dataValue;

                // Stop looking through the JSON
                break;
              }
            }
          }

          // Bind the data to the SVG and create one path per GeoJSON feature
          svg
            .selectAll("path")
            .data(json.features)
            .enter()
            .append("path")
            .attr("d", path)
            .style("stroke", "#fff")
            .style("stroke-width", "1")
            .style("fill", function (d) {
              return ramp(d.properties.value);
            })
            .on("mouseover", function (d, i) {
              tooltip
                .html(`${d.properties.name}: ${d.properties.value}`)
                .style("visibility", "visible");
              svg.selectAll("path").attr("opacity", 0.4);
              d3.select(this).attr("opacity", 1);
            })
            .on("mousemove", function () {
              tooltip
                .style("top", event.pageY - 60 + "px")
                .style("left", event.pageX - 100 + "px");
            })
            .on("mouseout", function () {
              svg.selectAll("path").attr("opacity", 1);
              tooltip.html(``).style("visibility", "hidden");
            });

          // add a legend
          var w = 140,
            h = 300;

          var key = d3
            .select("#container-chart")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .attr("class", "legend");

          var legend = key
            .append("defs")
            .append("svg:linearGradient")
            .attr("id", "gradient")
            .attr("x1", "100%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "100%")
            .attr("spreadMethod", "pad");

          legend
            .append("stop")
            .attr("offset", "0%")
            .attr("stop-color", highColor)
            .attr("stop-opacity", 1);

          legend
            .append("stop")
            .attr("offset", "100%")
            .attr("stop-color", lowColor)
            .attr("stop-opacity", 1);

          key
            .append("rect")
            .attr("width", w - 100)
            .attr("height", h)
            .style("fill", "url(#gradient)")
            .attr("transform", "translate(0,10)");

          var y = d3.scaleLinear().range([h, 0]).domain([minVal, maxVal]);

          var yAxis = d3.axisRight(y);

          key
            .append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(41,10)")
            .call(yAxis);
        });
      });

      svg
        .append("text")
        .attr("x", width / 2)
        .attr("y", 0 - margin.top / 2)
        .attr("text-anchor", "middle")
        .style("font-size", "20px")
        .style("text-decoration", "underline")
        .text(
          "# of nonimmigrant worker admissions to the US by state in 2021"
        );
    </script>
  </body>
</html>
